<!DOCTYPE html>
<meta charset="utf-8">
<title>sankey-leaflet</title>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />

<style>
body {
  position: absolute;
  width:100%;
  height: 100%;
  margin: 0px;
}
#map {
  top:0px;
  left:0px;
  right:0px;
  /*bottom: 0px;*/
  height: 100%;
}
#msg-box, #randomize {
  position:absolute;
  top: 90px;
  left: 20px;
  font-size: 14px;
  line-height: 20px;
  padding: 5px;
  border: 1px solid black;
  font-family: sans-serif;
  background-color: white;
}
#randomize {
  top: 140px;
  cursor: pointer;
}
path {
  fill: none;
  stroke: #4682B4;
  stroke-opacity: 0.6;
  stroke-linecap: round;
  cursor: pointer;
}
path:hover {
  stroke-opacity: 0.8;
  stroke: #315B7E;
}
</style>

<body>
<div id="map"></div>
</body>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="../spatialsankey.js"></script>

<script type="text/javascript">
  
  // Set leaflet map
  var map = new L.map('map', {
            center: new L.LatLng(50,15),
            zoom: 4,
            minZoom: 0,
            maxZoom: 18
          });

  var tonerUrl = "http://{S}tile.stamen.com/toner-lite/{Z}/{X}/{Y}.png";
   
  var url = tonerUrl.replace(/({[A-Z]})/g, function(s) {
    return s.toLowerCase();
  });
   
  var basemap = L.tileLayer(url, {
    subdomains: ['','a.','b.','c.','d.'],
    minZoom: 0,
    maxZoom: 20,
    type: 'png',
    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>'
  });
   
  basemap.addTo(map);

  // Initialize the SVG layer
  map._initPathRoot()

  // Setup svg element to work with
  var svg = d3.select("#map").select("svg"),
      linklayer = svg.append("g"),
      nodelayer = svg.append("g");

  // Load data asynchronosuly
  d3.json("nodes.json", function(nodes) {
    d3.csv("links.csv", function(links) {

      // Setup spatialsankey object
      var spatialsankey = d3.spatialsankey()
                              .map(map)
                              .nodes(nodes)
                              .links(links);
      
      // Update nodes and links objects
      nodes = spatialsankey.nodes();
      links = spatialsankey.links();

      // Set node and link drawing functions
      var node = spatialsankey.node(),
          link = spatialsankey.link(),
          linkwidth = link.width();

      var mouseover = function(d){
        // Get link data for this node
        var nodelinks = links.filter(function(link){
          return link.source == d.properties.id;
        });

        // Add data to link layer
        var beziers = linklayer.selectAll("path").data(nodelinks);

        // Draw new links
        beziers.enter()
          .append("path")
          .attr("d", link)
          .attr('id', function(d){return d.id})
          .style("stroke-width", linkwidth);
        
        // Remove old links
        beziers.exit().remove();

        // Hide inactive nodes
        var circleUnderMouse = this;
        circs.transition().style('opacity',function () {
            return (this === circleUnderMouse) ? 0.7 : 0;
        });
      };

      var mouseout = function(d) {
        // Remove links
        linklayer.selectAll("path").remove();
        // Show all nodes
        circs.transition().style('opacity', 0.7);
      };

      // Draw circles at nodes
      var circs = nodelayer.selectAll("circle")
        .data(nodes.features)
        .enter()
        .append("circle")
        .attr("cx", node.cx)
        .attr("cy", node.cy)
        .attr("r", node.r)
        .attr("opacity", 0.7)
        .style("fill", node.fill)
        .on('mouseover', mouseover)
        .on('mouseout', mouseout);
      
      // Adopt draw size after leaflet zoom reset
      var zoomend = function(){
          linklayer.selectAll("path").attr("d", link);

          circs.attr("cx", node.cx)
               .attr("cy", node.cy);
      };
   
      map.on("zoomend", zoomend);
    });
  });
</script>
